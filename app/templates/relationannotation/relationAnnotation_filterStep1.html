<!DOCTYPE html>
<html style="border: 3px solid #5399b4;">

<head>
  <title>Crowd-powered argument annotation</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Include bootstrap, jQuery, Popper -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

  <script src="https://kit.fontawesome.com/172b48191c.js" crossorigin="anonymous"></script>

  <link rel="stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/relationannotation.css') }}">


  
  <script type="text/javascript">
    
    $("document").ready(function() {
      $(document).ready(function(){
        // enable tooltips
        $('.tooltip-wrapper').tooltip({position: "bottom"});
        // enable popovers
        $('[data-toggle="popover"]').popover()
      });

      // set mturk form action so that when worker submits the hit the results data is sent to the correct mturk url
      $("#mturk_form").attr("action", {{turkSubmitTo|tojson}});



      loadAllLocalStorageElements();
      
      logger = logger.concat(Date.now(), "/Page loaded. Preview_mode=", {{ preview_mode }}, "//");

      if (window.informedConsentCheckBox == true) {
        $('#informedConsentCheckBox').prop('checked', true);
      }
      else {
        $('#informedConsentCheckBox').prop('checked', false);
      }


      window.annotation_types = {{annotation_types|tojson}};
      window.annotations = {{annotations|tojson}};


      window.relation_types = {{relation_types|tojson}};


      // set the worker's assignment id so that mturk can process it as soon as worker submits the assignment
      $("#assignmentId").val({{worker_assignment_data|tojson}}.assignment_id);
      // additionally, we can already set the annotations_on_load since they won't change anyway
      $("#annotations_on_load").val(JSON.stringify({{annotations|tojson}}));

      createAllAnnotationTypeCssClasses(annotation_types);
      displayAllRelationTypeButtons(relation_types);


      window.pressedRelationAnnotationButton = "";

      
      // set name and value of li element to name/value of child radio button. This makes it possible to check radio button if worker clicks on description
      $( "#certaintyRadioButtons input" ).each(function( index ) {
        let radio_value = $(this).attr("value");
        $(this).parent().attr("value", radio_value);
      });


      // load already checked answers as sent by server
      loadFeedback();


      jumpToPage(window.paragraphNumber);


      $('#mturk_form').submit(function(event) {
        event.preventDefault(); // this prevents the default submit
        logger = logger.concat(Date.now(), "/Submit", "//");
        updateMTurkForm();

        // print data on heroku for safety reasons
        printDataOnServer("SUBMIT RELATION");
        

        // clear all worker data in local storage when worker submits HIT
        // loop through all elements of local storage to delete the ones which were created during this assignment.
        // Further, check if any local storage elements are found which are older than one week. If yes, extract the assignment id of the outdated element and delete all local storage elements which contain this id.
        // By that we make sure that a worker's local storage is kept clean and that the maximum size of a worker's local storage is not exceeded.
        // This is needed since localstorage elements are initiated on page load (also in preview mode).
        var locstor_keys = Object.keys(window.localStorage);
        var assignment_id = {{worker_assignment_data|tojson}}.assignment_id;
        $.each(locstor_keys, function(index, key) {
          if (key.includes(assignment_id)) {
            // The key of this element contains this assignment's id, therefore delete it.
            window.localStorage.removeItem(key);
          }
          else if (key.includes("timestamp")) {
            // this element was created during another assignment
            // check whether the timestamp is more than one week old
            let assignment_timestamp = parseInt(window.localStorage.getItem(key));
            let time_since_creation_in_days = Math.abs(assignment_timestamp - Date.now()) / 1000 / 60 / 60 / 24;
            
            if (time_since_creation_in_days > 7) {
              // Local storage element is outdated!
              // This assignment was done more than one week ago. Loop again through all elements of local storage to delete the ones which were created during this assignment.
              var assignment_id_of_expired_assignment = key.replace("timestamp", "");
              var locstor_keys_new = Object.keys(window.localStorage);
              $.each(locstor_keys_new, function(index_expired, key_expired) {
                if (key_expired.includes(assignment_id_of_expired_assignment)) {
                  // The key of this element contains the id of the expired assignment, therefore delete it.
                  window.localStorage.removeItem(key_expired);
                }
              })
            }

          }
        })

        // submit assignment and send data to mturk
        $(this).unbind('submit').submit(); // continue with the submit
      })

    });


    function printDataOnServer(message) {
      // get timestamp
      var currentTimeInMs = Date.now();

      var submit_DATA = {'message': message, 'timestamp': currentTimeInMs, 'annotations_on_load': JSON.stringify(window.annotations), 'annotations': JSON.stringify(window.relation_annotations), 'filterData_step1': JSON.stringify(window.filterData_step1),  'worker_assignment_data': JSON.stringify({{worker_assignment_data|tojson}}), 'feedback': $("textarea[name='feedback']").val(), 'logger': window.logger};

      $.getJSON('{{url_for('textannotation_bp.submit_data_relation')}}', submit_DATA, function(data) {
        console.log("data was successfully sent to the server");
        console.log(data);
      })
    }


    function displayTextToAnnotate(paragraph, annotations) {
      var textToAnnotateDIV = $('#textToAnnotate');
      textToAnnotateDIV.empty();

      let text_to_annotate = ({{text_to_annotate|tojson}})[paragraph];

      $.each(text_to_annotate, function(id, token_dict) {
        textToAnnotateDIV.append($('<span id=' + id + '>' + token_dict.token + ' </span>'));
      });

      annotateTextAll(annotations, paragraph);
      wrapButtonsAroundAnnotations();
    };
      
    function displayQuestionsFILTERSTEP1() {
      $("#filter_step1_content form").empty();
      let filter_questions_step1 = ({{filter_questions_step1|tojson}});
      
      var filterInstructionsDIV = $('#filter-instructions');
      filterInstructionsDIV.empty();
      var filter_instructions = ({{filter_instructions_step1|tojson}});
      filterInstructionsDIV.append(filter_instructions);

      $.each(filter_questions_step1, function(question) {
          
        //var filter_text_to_annotate = filter_questions_step1[current_filter_step]['text_to_annotate'];
        let text = filter_questions_step1[question]["text"];

        let instructions = "<span style='color:#0075ff'>" + filter_questions_step1[question]["instructions"] + "</span>";
        let options = filter_questions_step1[question]["options"];

        let filter_step1_question_html = `
        <div style="border-bottom: 3px solid lightgrey; padding-bottom: 5px;">
          <p></p>
          <div id="filter_step1_text">${text}</div>
          <div>${instructions}
        `
        
        $.each(options, function(index, option) {

          let option_id = option[0];
          let option_text = option[1];
          var option_html = `
            <div class="form-check">
              <input type="radio" class="form-check-input" name="${question}" id="${option_id}">
              <label class="form-check-label" for="${option_id}">${option_text}</label>
            </div>
          `
          filter_step1_question_html += option_html;
          
        });

        filter_step1_question_html += `</div>`;

        $("#filter_step1_content form").append(filter_step1_question_html);

      });

      loadFilterStep1Answers();

    };
      
    function loadFilterStep1Answers() {
      $.each(filterData_step1["selectedOptions"], function(index, option) {
        $("input[name='" + option["question"] + "'][id='" + option["answer"] + "']").prop("checked", true);
      });
    }

    function annotateTextAll(annotations, paragraph) {
      if (paragraph in annotations) {
        
        for (var i = 0; i < annotations[paragraph].length; i++) {

          let start = annotations[paragraph][i][0];
          let end = annotations[paragraph][i][1];
          var annotation = annotations[paragraph][i][2];
          for (var j = parseFloat(start); j <= parseFloat(end); j++){
            if (j == parseFloat(start)) {
              addTokenAnnotation(j, annotation, "firstToken")
            }
            if (j == parseFloat(end)) {
              addTokenAnnotation(j, annotation, "lastToken")
            }
            if ((j > parseFloat(start)) | (j < parseFloat(end))) {
              addTokenAnnotation(j, annotation, false);
            }
          }
          addAnnotationName(end, annotation);
        }
      }
    };

    function wrapButtonsAroundAnnotations() {
      var numberOfRelationTypes = annotation_types.length;
      for (var i = 0; i < numberOfRelationTypes; i++) {
        // loop through all relation types
        let className = annotation_types[i][0];
        //let displayName = annotation_types[i][1]; // not needed
        //let color = annotation_types[i][2]; // not needed
        
        // loop through all argumentative components and wrap an a-span around them to make them clickable
        // including #textToAnnotate makes sure that content of example buttons is not considered
        $.each($( "#textToAnnotate ." + className + ".firstToken" ), function(index, element) {
          // loop through all first tokens of annotation of type (according to outer loop)
          // select all annotated tokens
          let selectRestOfAnnotation = $(element).nextUntil( ".annotationName" ).addBack();
          // add annotation name span to selection
          let selectRestOfAnnotationIncludingAnnotationName = selectRestOfAnnotation.next().addBack();
          // wrap button around all annotations for each annotation type
          $(selectRestOfAnnotationIncludingAnnotationName).wrapAll( "<a class=annotationForRelation></a>" );
        });
        
      }

    }

    function createAllAnnotationTypeCssClasses(annotation_types) {
      var numberOfRelationTypes = annotation_types.length;
      for (var i = 0; i < numberOfRelationTypes; i++) {
        // create css classes on the fly for each annotation type
        
        let className = annotation_types[i][0];
        let displayName = annotation_types[i][1];
        let color = annotation_types[i][2];
        
        
        $("<style type='text/css'> ." + className + " {\
          background-color: " + color + ";\
          color: white;\
          }</style>").appendTo("head");

        if (i == 0) {
          var marginLeft = "0px";
        }
        else {
          var marginLeft = "15px";
        }


        $("<style type='text/css'> .annotationName-" + className + " {\
          font-style: italic;\
          border-bottom: 3px solid " + color + ";\
          margin-right: 2px;\
          } </style>").appendTo("head");

      }
    };

    function displayAllRelationTypeButtons(relation_types) {
      var numberOfRelationTypes = relation_types.length;
      for (var i = 0; i < numberOfRelationTypes; i++) {
        // create css classes and html element on the fly for each button
        
        let className = relation_types[i][0];
        let displayName = relation_types[i][1];
        let color = relation_types[i][2];
        
        
        $("<style type='text/css'> ." + className + " {\
          background-color: " + color + " !important;\
          color: #595959;\
          }</style>").appendTo("head");

        if (i == 0) {
          var marginLeft = "0px";
        }
        else {
          var marginLeft = "15px";
        }

        $("<style type='text/css'> #relationButtons #" + className + " {\
          color: #595959;\
          padding: 5px;\
          margin-left: " + marginLeft + ";\
          background-color: " + color + ";\
          border-top-right-radius: 0px;\
          border-bottom-right-radius: 0px;\
          }</style>").appendTo("head");

        $("<style type='text/css'> #relationButtons #" + className + ":hover:enabled {\
          border: 3px solid white;\
          padding: 2px;\
          }</style>").appendTo("head");

        $("<style type='text/css'> .annotationName-" + className + " {\
          font-style: italic;\
          font-size: small;\
          border-bottom: 3px solid " + color + ";\
          margin-right: 2px;\
          } </style>").appendTo("head");

        $('#relationButtons').append($('\
          <button class="btn btn-basic ' + className + '" id="' + className + '" disabled>'+ displayName + '</button>\
          '));
      }
    };

    function addTokenAnnotation(tokenId, annotation, styleClass) {
      $("#"+tokenId).addClass(annotation);
      if (!(styleClass === false)) {
        $("#"+tokenId).addClass(styleClass);
      }
    };

    function addAnnotationName(tokenId_before, annotation) {
      
      let displayName = (window.annotation_types.find(type => type[0] == annotation)[1]);

      $('<span class="annotationName annotationName-' + annotation + '" id=' + (tokenId_before+0.5) + '> ' + displayName + ' </span>').insertAfter("#" + tokenId_before);
    };


    function loadFeedback() {
      // set the value of the feedback input box based on local storage data
      $("textarea[name='feedback']").val(window.feedback);
    }


  </script>

  <script>
    $(document).ready(function () {

      // make sure that focus is on text field as soon as certainty modal is opened
      $('#certaintyModal').on('shown.bs.modal', function () {
        $('#certaintyModalInput').trigger('focus')
      });

      $('#certaintyModal').on('hidden.bs.modal', function () {
        // whenever the modal is closed, reset worker selection
        resetCurrentlySelectedAnnotations();
      });


      $(document).on("click", ".annotationForRelation", function(){
        // click event of highlighted annotations in text is nested in a document click event listener since those buttons (for selecting an annotation) are created dynamically

        let annotationTokens = $(this).children();
        // get the id of the first token of the clicked annotation
        let firstTokenID = parseInt(annotationTokens[0].id);
        // get the id of the last token of the clicked annotation
        let lastTokenID = parseInt(annotationTokens[annotationTokens.length - 2].id);
        
        let currentSelection = window.currentlySelectedAnnotations;

        if ((currentSelection.annotation_1.start == firstTokenID && currentSelection.annotation_1.end == lastTokenID) || (currentSelection.annotation_2.start == firstTokenID && currentSelection.annotation_2.end == lastTokenID)) {
          // selected annotation is already selected
          removeAnnotationFromCurrentSelection(parseInt(firstTokenID), parseInt(lastTokenID));
        }
        else {
          // selected annotation is a new selection
          addAnnotationToCurrentSelection(firstTokenID, lastTokenID);
        }

      });



      $('#relationButtons > button').not('button.relationInfoButton').on('click',(function () {
        window.modalMode = 'NewAnnotation';
        window.switchedSelectionsInModal = false;


        // clear certainty modal radio button and input text
        $("#certaintyRadioButtons input:radio:checked").prop("checked", false);
        $('#certaintyModalInput').val("");
        // remove all red borders
        $("#certaintyRadioButtons").css("border", "");
        $("#keywordSelection_1").css("border", "");
        $("#keywordSelection_2").css("border", "");
        $("#certaintyModalInput").css("border", "");
        // hide delete button
        $("#deleteAnnotation-wrapper").addClass("hidden");
        // hide changeAnnotationType buttons
        $("#changeAnnotationType").addClass("hidden");
        // set text of save annotation button
        $("#saveAnnotation").text("Save Relation");
        // disable the save annotation button
        $('#saveAnnotation').prop("disabled", true);

        
        var keywordSelectionDIV_1 = $('#keywordSelection_1');
        var keywordSelectionDIV_2 = $('#keywordSelection_2');
        keywordSelectionDIV_1.empty();
        keywordSelectionDIV_2.empty();


        if ((Math.abs(currentlySelectedAnnotations.annotation_1.end - currentlySelectedAnnotations.annotation_1.start) < 1) && (Math.abs(currentlySelectedAnnotations.annotation_2.end - currentlySelectedAnnotations.annotation_2.start) < 1)) {
          //hide keywords section title since both annotations only contain one token
          $("#keywordSelection-title").addClass("hidden");
        }
        else {
          // unhide keywordSelection-title
          $("#keywordSelection-title").removeClass("hidden");
        }
        
        let annotated_tokens_1 = $("#" + currentlySelectedAnnotations.annotation_1.start).parent().children().clone();
        let annotated_tokens_2 = $("#" + currentlySelectedAnnotations.annotation_2.start).parent().children().clone();

        $.each(annotated_tokens_1, function(nr, annotatedTokenSpan) {
          if (parseFloat(annotatedTokenSpan.id) % 1 == 0) {
            keywordSelectionDIV_1.append($(annotatedTokenSpan));
          }
        });

        $.each(annotated_tokens_2, function(nr, annotatedTokenSpan) {
          if (parseFloat(annotatedTokenSpan.id) % 1 == 0) {
            keywordSelectionDIV_2.append($(annotatedTokenSpan));
          }
        });


        keywordSelectionDIV_1.children().wrap( "<a class='keywordSelectionButton'></a>" );
        keywordSelectionDIV_2.children().wrap( "<a class='keywordSelectionButton'></a>" );

        $(".keywordSelectionButton span").removeClass();

        // if one of the annotations only contains one token then autoselect it
        if (Math.abs(currentlySelectedAnnotations.annotation_1.end - currentlySelectedAnnotations.annotation_1.start) < 1) {
          $("#keywordSelection_1 #" + currentlySelectedAnnotations.annotation_1.start).parent().addClass("keywordSelectionButton-selected");
          // remove hover css classes
          $("#keywordSelection_1 .keywordSelectionButton-selected").hover(function() {
            $(this).css({"cursor":"default", "background-color":"orange"});
            $(this).addClass("autoselected");
          });
        }

        if (Math.abs(currentlySelectedAnnotations.annotation_2.end - currentlySelectedAnnotations.annotation_2.start) < 1) {
          $("#keywordSelection_2 #" + currentlySelectedAnnotations.annotation_2.start).parent().addClass("keywordSelectionButton-selected");
          // remove hover css classes
          $("#keywordSelection_2 .keywordSelectionButton-selected").hover(function() {
            $(this).css({"cursor":"default", "background-color":"orange"});
            $(this).addClass("autoselected");
          });
        }
      


        window.pressedRelationAnnotationButton = this.id;
        let relationType_displayName = $(this).html();

        // first remove all classes and then add class to modalheader for css styling reasons
        $(".modal-header").removeClass().addClass("modal-header").addClass(window.pressedRelationAnnotationButton);
        // then extend the modal header text
        let headerText = "New relation" + ": <u><b>" + relationType_displayName + "</b></u>";
        $("#exampleModalLongTitle").html(headerText);


        // open the certainty modal
        $('#certaintyModal').modal({
          keyboard: false
        });
        
        logger = logger.concat(Date.now(), "/New relation. type=", pressedRelationAnnotationButton, "//");

        window.currentlySelectedAnnotations.relation_type = this.id;

      })
      );


      $(document).on("click", "#changeAnnotationType-buttons > button", function(){
        // click event of changeAnnotationType-buttons is nested in a document click event listener since these buttons are created dynamically when an annotation is being edited
        
        // change the annotation_type of the annotation based on the id of the pressed button
        window.pressedRelationAnnotationButton = this.id;

        console.log("changeAnnotationType-buttons:");
        console.log("window.pressedRelationAnnotationButton:");
        console.log(window.pressedRelationAnnotationButton);
        
        // remove the orange border from all buttons
        $("#changeAnnotationType-buttons > button").css("border", "4px solid white");
        // then add orange button to selected new annotation_type
        $("#changeAnnotationType-buttons #" + this.id).css("border", "4px solid orange");

        return false;
      });


      $('button#saveAnnotation').on('click',(function () {
        if (modalMode == 'EditAnnotation') {
          // get id of deleteButton
          let idToDelete = $(".deleteRelation").attr('id');

          var previousTableEntryID = $("#TableRow-" + idToDelete).prev().attr("id");

          // make sure that editing the relation does not edit it's ID
          var newAnnotationId = idToDelete;

          // delete annotation according to clicked delete button id
          // after relation is deleted create relation newly including the changes
          deleteAnnotation(idToDelete);
        }
        else {
          // setting the previousTableEntryID var makes sure that the table row is added at the end of the table
          var previousTableEntryID = 'newTableEntry';
          console.log("previousTableEntryID2 edit NO:");
          console.log(previousTableEntryID);
          console.log(typeof previousTableEntryID == 'undefined');
          // if it is a new relation, get ID for new relation
          var newAnnotationId = 0;
          Object.keys(window.relation_annotations[window.paragraphNumber]).forEach((key, index) => {
            // loop through all existing relation_annotations to increment new key from currently highest
            if (parseInt(key) >= newAnnotationId) {
              newAnnotationId = parseInt(key) + 1;
            }
          })
        }


        let selectedKeywords_1 = $("#keywordSelection_1 .keywordSelectionButton.keywordSelectionButton-selected");
        let selectedKeywords_2 = $("#keywordSelection_2 .keywordSelectionButton.keywordSelectionButton-selected");
        var selectedKeywordIDs = {keywordSelection_1: [], keywordSelection_2: []};
        console.log("selectedKeywordIDs:");
        console.log(selectedKeywordIDs);

        // loop through all selected keywords and add them to the array so that it can be saved within the new annotation

        selectedKeywords_1.each(function( index ) {
          let token_id = $(this).children("span").first().attr("id");
          selectedKeywordIDs.keywordSelection_1.push(token_id);
        });
        selectedKeywords_2.each(function( index ) {
          let token_id = $(this).children("span").first().attr("id");
          selectedKeywordIDs.keywordSelection_2.push(token_id);
        });
        
        console.log("selectedKeywordIDs2222:");
        console.log(selectedKeywordIDs);

        let certaintyModalInput = $('#certaintyModalInput').val();
        let certaintyButton = $('#certaintyRadioButtons input:radio:checked').val();

        if (certaintyButton == null) {
          certaintyButton = -1;
        }
        

        if (window.switchedSelectionsInModal === true) {
          // the worker switched the selected annotations in the edit modal. Therefore, change exchange them when they are added to the global variable

          let annotation_1_old = window.currentlySelectedAnnotations.annotation_1;
          let annotation_2_old = window.currentlySelectedAnnotations.annotation_2;
          window.currentlySelectedAnnotations.annotation_1 = annotation_2_old;
          window.currentlySelectedAnnotations.annotation_2 = annotation_1_old;
        }

        if (modalMode == 'EditAnnotation') {
          window.currentlySelectedAnnotations.relation_type = window.pressedRelationAnnotationButton;
        }
        
        // push newly annotated relation to global variable
        window.relation_annotations[window.paragraphNumber][newAnnotationId] = [window.currentlySelectedAnnotations, certaintyButton, certaintyModalInput, selectedKeywordIDs, [({{text_to_annotate|tojson}})[window.paragraphNumber][window.currentlySelectedAnnotations.annotation_1.start]["start"], ({{text_to_annotate|tojson}})[window.paragraphNumber][window.currentlySelectedAnnotations.annotation_1.end]["end"]], [({{text_to_annotate|tojson}})[window.paragraphNumber][window.currentlySelectedAnnotations.annotation_2.start]["start"], ({{text_to_annotate|tojson}})[window.paragraphNumber][window.currentlySelectedAnnotations.annotation_2.end]["end"]]];
        
        
        addRowToAnnotationRelationsTable(newAnnotationId, window.currentlySelectedAnnotations, previousTableEntryID);

        disableRelationButtons();
      
        // and hide modal
        $('#certaintyModal').modal('toggle');


        updateWorkerData();

        logger = logger.concat(Date.now(), "/Save relation. relation=", JSON.stringify(currentlySelectedAnnotations), "//");

        // new relation annotation is finished which is why now we can reset all contents of global variable for currently selected annotations
        resetCurrentlySelectedAnnotations();

      }));

      $(document).on("click", "#relationsTable .editAnnotationIcon", function(){
        // click event of delete relation is nested in a document click event listener since relation table is changed dynamically

        resetCurrentlySelectedAnnotations();

        window.switchedSelectionsInModal = false;

        let idToEdit = event.target.parentElement.id;
        editAnnotation(idToEdit);
        logger = logger.concat(Date.now(), "/Edit relation. id=", idToEdit, "//");
      });


      $('button.deleteRelation').on('click',(function () {
        // get id of deleteButton
        let idToDelete = $(".deleteRelation").attr('id');

        // delete annotation according to clicked delete button id
        deleteAnnotation(idToDelete);
        
        resetCurrentlySelectedAnnotations();

        // hide modal
        $('#certaintyModal').modal('toggle');
        
        updateWorkerData();

      }));


      /* click handlers so that every time a worker enters something in the modal, the save annotation button is enabled in case no input is missing anymore. This makes sure that a worker always has to fill out everything */


      $(document).on("click", ".keywordSelectionButton", function(){
        // click event of keyword buttons is nested in a document click event listener since keyword buttons are created dynamically
        // check if the a tag has the class 'autoselected'. If yes, it means that the argumentative component consists of only one token. Therefore it was autoselected and hence the class should not be toggled as these keywords should not be unselected.
        if ($(this).hasClass("autoselected") === false) {
          $(this).toggleClass("keywordSelectionButton-selected");
          updateSaveAnnotationButton();
        }

        return false;
      });

      $(".switchSelectedAnnotations").on('click',(function () {

        console.log("AAAAA");

        window.switchedSelectionsInModal = !window.switchedSelectionsInModal;
        console.log("window.switchedSelectionsInModal:");
        console.log(window.switchedSelectionsInModal);

        // switch the IDs of the two keyword elements
        $("#keywordSelection_1").attr("id", "keywordSelection_1-switch");
        $("#keywordSelection_2").attr("id", "keywordSelection_2-switch");
        $("#keywordSelection_1-switch").attr("id", "keywordSelection_2");
        $("#keywordSelection_2-switch").attr("id", "keywordSelection_1");

        // and then switch the two keyword elements
        $("#selection1title").after($("#keywordSelection_1"));
        $("#selection2title").after($("#keywordSelection_2"));
        

      }));

      $(function(){
        // whenever a radiobutton is clicked, check if save annotation button can be enabled
        $('#certaintyRadioButtons li').click(function(){
          updateSaveAnnotationButton();
        });

        // whenever feedback-textfield changes, update worker data on server
        $("textarea[name='feedback']").on('change keydown paste input', function(){
          updateWorkerData();
        });

      });

      $("#saveAnnotationWrapper").hover(function(){
        // when worker hovers over disabled saveAnnotation-button, indicate all empty inputs with a red border
        updateSaveAnnotationButton(true);
      });

      $("#certaintyRadioButtons li").click(function(){
        // worker clicks on label or next to label, then automatically check the nearby radio button in annotation modal
        let li_value = $(this).attr("value");
        $("input[name='likert'][value='" + li_value + "']").prop("checked", true);
        updateSaveAnnotationButton();
      });
      
      $(document).on("click", "#filter_step1_content input", function(){
        // worker clicks on single choice answer in filter (Step 1)
        updateFilter1Object();
      });

    });

    function updateFilter1Object() {

      let checkedFilter1RadioButtons = $("#filter_step1_content input:radio:checked");
      // loop through all filter step 1 questions and push the checked ones to the array
      $.each(checkedFilter1RadioButtons, function(id, token) {
        let question = $(token).attr("name");
        let answer = $(token).attr("id");
        // if question is already in array remove it
        filterData_step1["selectedOptions"] = filterData_step1["selectedOptions"].filter(function(e) { return e.question != question; });
        // add new or updated answer to array
        filterData_step1["selectedOptions"].push({"question": question, "answer": answer});
      });

      updateWorkerData();
    }

    function addAnnotationToCurrentSelection(start, end) {
      var currentSelection = window.currentlySelectedAnnotations;

      if (currentSelection.annotation_1.start == -1 && currentSelection.annotation_1.end == -1) {
        // check if there is none of the annotations is already selected
        // set IDs of start- and end-token of first selected annotation 
        currentSelection.annotation_1.start = start;
        currentSelection.annotation_1.end = end;
        markAnnotationAsSelected(start, end);
        
      }
      else if (currentSelection.annotation_2.start == -1 && currentSelection.annotation_2.end == -1) {
        // there is at least one selected annotation. check if there is no second selected annotation yet
        // set IDs of start- and end-token of second selected annotation 
        currentSelection.annotation_2.start = start;
        currentSelection.annotation_2.end = end;
        markAnnotationAsSelected(start, end);

      }
      else {
        // there are already two selected annotations

      }

      if (currentSelection.annotation_1.start != -1 && currentSelection.annotation_1.end != -1 && currentSelection.annotation_2.start != -1 && currentSelection.annotation_2.end != -1) {
        // there are two selected annotations, therefore:
        // disable all annotations except the two which are already selected
        $("#textToAnnotate a").not(".selected").addClass("disabled");

        // and enable relation annotation buttons
        enableRelationButtons();

      }
      else {
        // less than two annotations are selected, therefore:
        // enable all annotations
        $("#textToAnnotate a").removeClass("disabled");
        // and disable relation annotation buttons
        disableRelationButtons();

      }
      //window.currentlySelectedAnnotations ;

      //update global variable
      window.currentlySelectedAnnotations = currentSelection;

      // add argumentative components which were selected by the user to the tentative table row
      addTENTATIVERowToAnnotationRelationsTable();
    }

    function removeAnnotationFromCurrentSelection(start, end) {
      unmarkAnnotationAsSelected(start, end);

      // obviously now less than two annotations are selected, therefore:
      // enable all annotations
      $("#textToAnnotate a").removeClass("disabled");
      // and disable relation annotation buttons
      disableRelationButtons();


      var currentSelection = window.currentlySelectedAnnotations;

      if (currentSelection.annotation_1.start == start && currentSelection.annotation_1.end == end) {
        // first of the two selected annotations was dis-selected
        currentSelection.annotation_1.start = -1;
        currentSelection.annotation_1.end = -1;

      }
      else {
        // second of the two selected annotations was dis-selected
        currentSelection.annotation_2.start = -1;
        currentSelection.annotation_2.end = -1;
      }
      currentSelection.relation_type = "";

      //update global variable
      window.currentlySelectedAnnotations = currentSelection;

      // update the tentative table row
      addTENTATIVERowToAnnotationRelationsTable();

    }

    function markAnnotationAsSelected(start, end) {
      // select html element of annotation that was selected and add class 'selected'
      let aTagOfSelectedAnnotation = $("#textToAnnotate a").has("#" + start);
      aTagOfSelectedAnnotation.addClass("selected");
    }

    function unmarkAnnotationAsSelected(start, end) {
      // select html element of annotation that was selected and remove class 'selected'
      let aTagOfSelectedAnnotation = $("#textToAnnotate a").has("#" + start);
      aTagOfSelectedAnnotation.removeClass("selected");
    }

    function resetCurrentlySelectedAnnotations() {
      // this function resets all currently selected argumentative components by the user
      console.log("");
      console.log("x");
      console.log(window.relation_annotations[window.paragraphNumber]);
      console.log("");
      // reset the global variable for the currently selected annotations
      window.currentlySelectedAnnotations = {annotation_1: {start: -1, end: -1}, annotation_2: {start: -1, end: -1}, relation_type: ""};

      // unselect all annotations
      $("#textToAnnotate a").removeClass("selected");
      // enable all annotations
      $("#textToAnnotate a").removeClass("disabled");
      // and disable relation annotation buttons
      disableRelationButtons();

      // remove the current tentative table row
      removeTENTATIVERowFromAnnotationRelationsTable();
    }
    

    function addRowToAnnotationRelationsTable(newAnnotationId, relationAnnotation, previousTableEntryID) {
      let tokensOfSelectedAnnotation_1 = $("#textToAnnotate a").has("#" + relationAnnotation.annotation_1.start).children().clone();
      let tokensOfSelectedAnnotation_2 = $("#textToAnnotate a").has("#" + relationAnnotation.annotation_2.start).children().clone();
      let selectedRelationClassName = relationAnnotation.relation_type;
      var selectedRelationDisplayName = "";
      
      for (var i = 0; i < relation_types.length; i++) {
        // loop through all relation_types to find the display name of the selected relation
        if (selectedRelationClassName == relation_types[i][0]) {
          var selectedRelationDisplayName = relation_types[i][1];
        }
      }


      let newTableEntryHtml = "\
            <tr id='TableRow-" + newAnnotationId + "' class='" + selectedRelationClassName + "'>\
              <td class='textColumn new_annotation_1'></td>\
              <td class='relation'>" + selectedRelationDisplayName + "</td>\
              <td class='textColumn new_annotation_2'></td>\
              <td class='editRelationColumn'>\
              <button type='button' class='close editAnnotation' aria-label='Close'><span id=" + newAnnotationId + " class='editAnnotationIcon' aria-hidden='true'><i class='fas fa-ellipsis-h editAnnotationIcon'></i></span></button>\
              </td>\
            </tr>\
            "
      

      if (previousTableEntryID == 'newTableEntry') {
        // this table row is added because the table is loaded or because the worker created a new relation. Insert the table row at the END of the table.
        $("#relationsTable tbody").append(newTableEntryHtml);
      }
      else if (typeof previousTableEntryID != 'undefined') {
        // this table row is added because the worker edited the relation. Insert the table row IN THE SAME PLACE as it was before.
        $( newTableEntryHtml ).insertAfter( $( "#" + previousTableEntryID ) );
      }
      else {
        // this table row is added because the worker edited the relation. This row was at the BEGINNING of the table. Insert the table row IN THE SAME PLACE as it was before, hence in the BEGINNING.
        $( "#relationsTable tbody" ).prepend( newTableEntryHtml );
      }

      $.each(tokensOfSelectedAnnotation_1, function(nr, annotatedTokenSpan) {
        // append each token of the first selected annotation to the new table cell
        $("#relationsTable .new_annotation_1").append($(annotatedTokenSpan));
      });
      

      $.each(tokensOfSelectedAnnotation_2, function(nr, annotatedTokenSpan) {
        // append each token of the second selected annotation to the new table cell
        $("#relationsTable .new_annotation_2").append($(annotatedTokenSpan));
      });

      // remove the indicator classes of the new table cells so that selected annotations can be appended to the correct table row
      $("#relationsTable .new_annotation_1").removeClass("new_annotation_1");
      $("#relationsTable .new_annotation_2").removeClass("new_annotation_2");
      
      // update the size of the text within the newly added table row. This is necessary if the size has been changed by the worker.
      updateTextSize();

    }
    

    function addTENTATIVERowToAnnotationRelationsTable() {
      // first remove the current tentative table row so that a new tentative row can be created based on the currently selected argumentative components by the user
      removeTENTATIVERowFromAnnotationRelationsTable();

      var firstSelectionExists = (window.currentlySelectedAnnotations.annotation_1.start != -1);
      var secondSelectionExists = (window.currentlySelectedAnnotations.annotation_2.start != -1);

      console.log("");
      console.log("TENTATIVE ROW------");
      console.log("");
      console.log("window.currentlySelectedAnnotations:");
      console.log(window.currentlySelectedAnnotations);
      console.log("");

      if (firstSelectionExists) {
        var tokensOfSelectedAnnotation_1 = $("#textToAnnotate a").has("#" + window.currentlySelectedAnnotations.annotation_1.start).children().clone();
      }
      if (secondSelectionExists) {
        var tokensOfSelectedAnnotation_2 = $("#textToAnnotate a").has("#" + window.currentlySelectedAnnotations.annotation_2.start).children().clone();
      }
      

      let newTableEntryHtml = "\
            <tr id='TableRow-TENTATIVE'>\
              <td class='textColumn new_annotation_1_TENTATIVE'></td>\
              <td class='relation'>?</td>\
              <td class='textColumn new_annotation_2_TENTATIVE'></td>\
            </tr>\
            "
      

      // this table row is added because the table is loaded or because the worker created a new relation. Insert the table row at the END of the table.
      $("#relationsTable tbody").append(newTableEntryHtml);


      if (firstSelectionExists) {
        $.each(tokensOfSelectedAnnotation_1, function(nr, annotatedTokenSpan) {
          // append each token of the first selected annotation to the new table cell
          $("#relationsTable .new_annotation_1_TENTATIVE").append($(annotatedTokenSpan));
        });
      }
      

      if (secondSelectionExists) {
        $.each(tokensOfSelectedAnnotation_2, function(nr, annotatedTokenSpan) {
          // append each token of the second selected annotation to the new table cell
          $("#relationsTable .new_annotation_2_TENTATIVE").append($(annotatedTokenSpan));
        });
      }

      // remove the indicator classes of the new table cells so that selected annotations can be appended to the correct table row
      $("#relationsTable .new_annotation_1_TENTATIVE").removeClass("new_annotation_1_TENTATIVE");
      $("#relationsTable .new_annotation_2_TENTATIVE").removeClass("new_annotation_2_TENTATIVE");
      
      // update the size of the text within the newly added table row. This is necessary if the size has been changed by the worker.
      updateTextSize();

    }

    function removeRowFromAnnotationRelationsTable(annotationToDeleteID, paragraphNumber) {
      
      //delete the relation annotation from global object
      delete window.relation_annotations[paragraphNumber][annotationToDeleteID];
      console.log("new dict:");
      console.log(window.relation_annotations[paragraphNumber]);
      //remove corresponding row from table
      $("#relationsTable tr").has("span#" + annotationToDeleteID + ".editAnnotationIcon").remove();

    }

    function removeTENTATIVERowFromAnnotationRelationsTable() {
      console.log("function removeTENTATIVERowFromAnnotationRelationsTable...");
      $("#TableRow-TENTATIVE").remove();
    }

    function reloadAnnotationRelationsTable(paragraphNumber) {
      // empty the relationsTable body
      $("#relationsTable tbody").empty();
      
      Object.keys(window.relation_annotations[paragraphNumber]).forEach((key, index) => {
        // loop through all existing relation_annotations
        let value = window.relation_annotations[paragraphNumber][key][0];
        let relationClassName = value.relation_type;
        let relationDisplayName = value.relation_type;
        
        // add row to relations table for each of the existing relation annotations
        addRowToAnnotationRelationsTable(key, value, 'newTableEntry');
      })

    }



    function updateSaveAnnotationButton(onHover=false) {


      let certaintyRadioButton = $('#certaintyRadioButtons input:radio:checked').val();
      let keywordSelection_1 = $("#keywordSelection_1 .keywordSelectionButton.keywordSelectionButton-selected");
      let keywordSelection_2 = $("#keywordSelection_2 .keywordSelectionButton.keywordSelectionButton-selected");

      let certaintyRadioButton_isFilled = typeof certaintyRadioButton != 'undefined';


      if (Math.abs(currentlySelectedAnnotations.annotation_1.end - currentlySelectedAnnotations.annotation_1.start) < 1) {
        // set keywordSelection_1_isFilled=true since annotation consists of only one token
        var keywordSelection_1_isFilled = true;
      }
      else {
        var keywordSelection_1_isFilled = keywordSelection_1.length != 0;
      }

      if (Math.abs(currentlySelectedAnnotations.annotation_2.end - currentlySelectedAnnotations.annotation_2.start) < 1) {
        // set keywordSelection_2_isFilled=true since annotation consists of only one token
        var keywordSelection_2_isFilled = true;
      }
      else {
        var keywordSelection_2_isFilled = keywordSelection_2.length != 0;
      }
      

      //remove red border if now worker filled it out
      if (certaintyRadioButton_isFilled) {
        $("#certaintyRadioButtons").css("border", "");
      }
      if (keywordSelection_1_isFilled) {
        $("#keywordSelection_1").css("border", "");
      }
      if (keywordSelection_2_isFilled) {
        $("#keywordSelection_2").css("border", "");
      }

      if (certaintyRadioButton_isFilled && keywordSelection_1_isFilled && keywordSelection_2_isFilled) {
        // enable save button
        $('#saveAnnotation').prop("disabled", false);
        // deactivate popover
        $('#saveAnnotationWrapper').removeAttr( "data-original-title" );
        
      }
      else {
        // disable save button
        $('#saveAnnotation').prop("disabled", true);
        // activate popover
        $('#saveAnnotationWrapper').attr("data-original-title", "All inputs are required to save the relation.");

        if (onHover) {
          // if function was called because worker hovered over disabled saveAnnotation-button, visually show which input is missing
          //remove red border if now worker filled it out
          if (typeof certaintyRadioButton == 'undefined') {
            $("#certaintyRadioButtons").css("border", "2px solid red");
          }
          if (keywordSelection_1.length == 0) {
            $("#keywordSelection_1").css("border", "2px solid red");
          }
          if (keywordSelection_2.length == 0) {
            $("#keywordSelection_2").css("border", "2px solid red");
          }
        }
      }

      };




  </script>

    

</head>

<body>

  <div id="filter-alerts"></div>

  <div class="container-fluid justify-content-center">
    <div class="hidden row" id="instructions">
      <div id="general-instructions">{% block instructions %}{% endblock %}</div>
      <div id="startAnnotationButton" class="tooltip-wrapper disabled">
        <button id="startAnnotation" class="btn btn-success btn-lg btn-block">Start!</button>
      </div>
    </div>
    <div class="sticky-top" style="background-color: white;">
      <div style="background-color: white; height: 4px"></div>
      <div class="row progress hidden" id="progress">
          <div class="progress-bar bg-success" role="progressbar" aria-valuenow="70"
          aria-valuemin="0" aria-valuemax="100">
            <span class="sr-only"></span>
          </div>
      </div>
      
      <div id="filter-instructions" class="row justify-content-left hidden"></div>
      <div class="row justify-content-center hidden" id="userControls">
        <button id="smallerTextButton" class="btn btn-outline-primary"><i class="fa fa-font"></i></button>
        <button id="biggerTextButton" class="btn btn-outline-primary"><i class="fa fa-font"></i></button>
      </div>
      <div class="row justify-content-center hidden" id="relationButtons"></div>
    </div>
    <div class="row justify-content-center hidden" id="annotationArea-wrapper">
      <div class="col-sm" id="textToAnnotate-wrapper">
        <div id="textToAnnotate"></div>
      </div>
      <div class="col-sm" id="relationsTable">
        <table class="table table-sm">
          <thead id="tableHeader">
            <tr>
              <th scope="col">Text</th>
              <th scope="col" class="relationHeader">Relation</th>
              <th scope="col">Text</th>
            </tr>
          </thead>
          <tbody>
            <!-- initially the table is empty -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="row small hidden" id="filter_step1_content" style="margin: 0;">
      
      <div class="box box-primary">
        <div class="box-body">
          <form method="post">
          </form>
        </div>
      </div>


    </div>

    <div class="row hidden" id="filterButtonsStep1">
      <div class="col-sm" id="previousPage">
        <button id="previousPageButtonFILTERStep1" class="btn btn-basic previous">&laquo; Instructions</button>
      </div>
      <div class="col-sm" id="filterButtonsCheckStep1">
        <button id="checkFilterAnswerStep1" class="btn btn-success checkbutton">Continue</button>
      </div>
    </div>

    <div class="row hidden" id="navigationButtons">
      <div class="col-sm" id="previousPage">
        <button id="previousPageButton" class="btn btn-basic previous">&laquo; Previous</button>
      </div>
      <div class="col-sm" id="nextPage">
        <button id="nextPageButton" class="btn btn-basic next">Next &raquo;</button>
      </div>
    </div>
  </div>


  <div class="hidden container-fluid" id="feedback">
    <!-- HTML to handle creating the HIT form -->
    <form id="mturk_form" method="post" name="mturk_form">
      <input type='hidden' value='' name='assignmentId' id='assignmentId'/>
      <input type='hidden' value='' name='submit_filter_data_step1' id='submit_filter_data_step1'/>
      <input type='hidden' value='' name='annotations_on_load' id='annotations_on_load'/>
      <input type='hidden' value='' name='submit_annotations' id='submit_annotations'/>
      <input type='hidden' value='' name='submit_worker_assignment_data' id='submit_worker_assignment_data'/>
      <input type='hidden' value='' name='submit_logger' id='submit_logger'/>

      <div class="row justify-content-center">
        <strong>You're almost there!</strong>
      </div>
      <br>
      <div class="row justify-content-center">
        <h5>Please give us a feedback by answering the following questions and then submit the HIT:</h5>
      </div>
      <div class="row justify-content-center">
        <ul>
          <li>Was the Pop Quiz difficult?</li>
          <li>Was it easy to understand what the task is about?</li>
          <li>Were the instructions clear? If not, what exactly was not clear?</li>
          <li>Were the relations easy to identify?</li>
          <li>Is there any other feedback that could help us to improve the task?</li>
        </ul>
      </div>

      <div class="row justify-content-center" id="feedback-textbox">
        <textarea name="feedback" style="min-width: 80%" rows=4 placeholder="Please enter your feedback here..."></textarea>
      </div>
      
      <div class="row justify-content-center">
        <!-- HTML to handle submitting the HIT -->
        <button id="submitButton" class="btn btn-warning btn-lg btn-block" type="submit" value="Submit">Finish and Submit HIT</button>
      </div>
    </form>

    <div class="row justify-content-center">
      <button id="previousPageButton-feedback" class="btn btn-basic">&laquo; Previous</button>
    </div>

  </div>


  <!-- Certainty Modal -->
  <div class="modal fade" id="certaintyModal" tabindex="-1" role="dialog" aria-labelledby="certaintyModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div id="modal-header" class="modal-header">
          <h3 class="modal-title" id="exampleModalLongTitle">New Relation</h3>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="changeAnnotationType">
            <p class="font-weight-bold">Change relation type:</p>
            <div id="changeAnnotationType-buttons"></div>
          </div>

          <p class="font-weight-bold" style="margin-top: 6px;">Please indicate how certain you are that this relation is correct:</p>

          <div id="certaintyRadioButtons">
            <ul class='likert'>
              <li>
                <input type="radio" name="likert" value="not_certain">
                <label>Not certain at all</label>
              </li>
              <li>
                <input type="radio" name="likert" value="more_or_less_certain">
                <label>More or less certain</label>
              </li>
              <li>
                <input type="radio" name="likert" value="very_certain">
                <label>Very Certain</label>
              </li>              
            </ul>
          </div>

          <div id="keywordSelection-wrapper">
            <p id="keywordSelection-title" class="font-weight-bold" style="margin-top: 6px;">Please select those words which made you decide to do this annotation:</p>

            <div class="container">
              <div class="row">
                <div class="col">
                  <p id="selection1title"><i><u>Selection 1:</u></i></p>
                  <div id="keywordSelection_1"></div>
                </div>
                <div class="col d-flex justify-content-center" id="switchSelectedAnnotations-wrapper">
                  <button type='button' class='close switchSelectedAnnotations' aria-label='Close'><span class='switchSelections' aria-hidden='true'>
                    <i class="fas fa-exchange-alt"></i>
                  </span></button>
                </div>
                <div class="col">
                  <p id="selection2title"><i><u>Selection 2:</u></i></p>
                  <div id="keywordSelection_2"></div>
                </div>
              </div>
            </div>
            
          </div>
          
          <p class="font-weight-bold">Please specify what lead you to the decision to annotate these words / this sentence:
            <input id="certaintyModalInput" class="form-control" type="text" placeholder="Please specify in your own words...">
          </p>

        </div>
        <div class="modal-footer">
          <div id="deleteAnnotation-wrapper" class="mr-auto">
            <button type="button" class="btn btn-danger mr-auto deleteRelation" >Delete this Relation</button>
          </div>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <div id="saveAnnotationWrapper" class="tooltip-wrapper disabled" title="All inputs are required to save the relation.">
            <button id="saveAnnotation" type="button" class="btn btn-primary" disabled>Save Relation</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  


</body>

<script>




  $("button#smallerTextButton").on("click", function() {
    let oldSize = parseInt($("#textToAnnotate").css('font-size').replace('px', ''));
    let oldSizeTable = parseInt($("#relationsTable tbody tr td").css('font-size'));
    let newSize = (oldSize-2) + "px";
    let newSizeTable = (oldSizeTable-2) + "px";
    let newSizeEditAnnotationIcon = (oldSize+6) + "px";
    $("#textToAnnotate").css("fontSize", newSize);
    $(".table td, .table th").css("fontSize", newSizeTable);
    $(".editAnnotationIcon").css("fontSize", newSizeEditAnnotationIcon);
    //disable button if min font-size is set
    if (oldSize < 8) {
      $('button#smallerTextButton').prop("disabled", true);
    }
    //enable button for bigger text
    $('button#biggerTextButton').prop("disabled", false);
  });
  
  
  
  $("button#biggerTextButton").on("click", function() {
    let oldSize = parseInt($("#textToAnnotate").css('font-size').replace('px', ''));
    let oldSizeTable = parseInt($("#relationsTable tbody tr td").css('font-size'));
    let newSize = (oldSize+2) + "px";
    let newSizeTable = (oldSizeTable+2) + "px";
    let newSizeEditAnnotationIcon = (oldSize+10) + "px";
    $("#textToAnnotate").css("fontSize", newSize);
    $(".table td, .table th").css("fontSize", newSizeTable);
    $(".editAnnotationIcon").css("fontSize", newSizeEditAnnotationIcon);
    //disable button if max font-size is set
    if (oldSize > 50) {
      $('button#biggerTextButton').prop("disabled", true);
    }
    //enable button for smaller text
    $('button#smallerTextButton').prop("disabled", false);
  });


  function editAnnotation(idToEdit) {
    console.log("now i EDIT relation");

    window.modalMode = 'EditAnnotation';

    // clear certainty modal radio button and input text
    $("#certaintyRadioButtons input:radio:checked").prop("checked", false);
    $('#certaintyModalInput').val("");
    // remove all red borders
    $("#certaintyRadioButtons").css("border", "");
    $("#keywordSelection_1").css("border", "");
    $("#keywordSelection_2").css("border", "");
    $("#certaintyModalInput").css("border", "");
    // unhide delete button
    $("#deleteAnnotation-wrapper").removeClass("hidden");
    // unhide changeAnnotationType buttons
    $("#changeAnnotationType").removeClass("hidden");
    // add buttons to give worker the chance to change the annotation_type
    $("#changeAnnotationType-buttons").empty();
    

    // set text of save annotation button
    $("#saveAnnotation").text("Save Changes");

    // set id of delete button
    $("#deleteAnnotation-wrapper button").attr("id", idToEdit);


    // loop through all already existing annotations to load content of annotation to edit

    console.log("window.currentlySelectedAnnotations:");
    console.log(window.currentlySelectedAnnotations);

    console.log("id to edit: " + idToEdit);

    let relation_annotation_to_edit = window.relation_annotations[window.paragraphNumber][idToEdit];

    console.log("relation_annotation_to_edit:");
    console.log(relation_annotation_to_edit);


    // Set global values. This is needed to commit the changes. After worker is done editing the annotation will be deleted and saved as a new annotation including the changes.
    window.currentlySelectedAnnotations = relation_annotation_to_edit[0];

    // then set values used to fill the modal
    var relation_type = relation_annotation_to_edit[0].relation_type;
    var annotation_certainty = relation_annotation_to_edit[1];
    var annotation_inputText = relation_annotation_to_edit[2];
    var annotation_keywords = relation_annotation_to_edit[3];


    // loop through all relation types and remove borders to "dis-select" them
    let allAnnotationButtonsExcludingExampleButtons = $('#relationButtons > button').not('button.relationInfoButton');
    $.each(allAnnotationButtonsExcludingExampleButtons, function(id, token) {
      let annotationButton = $(token).clone();
      $(annotationButton).css("margin-right", "5px");
      $(annotationButton).css("border", "4px solid white");
      $(annotationButton).prop("disabled",false);
      $("#changeAnnotationType-buttons").append(annotationButton);
    });
    
    // highlight the currently selected relation type
    $("#changeAnnotationType-buttons #" + relation_type).css("border", "4px solid orange");

    console.log("");
    console.log("relation_type");
    console.log(relation_type);
    console.log(typeof relation_type);
    console.log("");

    window.pressedRelationAnnotationButton = relation_type;
    console.log("window.pressedRelationAnnotationButton");
    console.log(window.pressedRelationAnnotationButton);
    let annotationType_displayName = $("#" + relation_type).html();

    // first remove all classes and then add class to modalheader for css styling reasons
    $(".modal-header").removeClass().addClass("modal-header").addClass(window.pressedRelationAnnotationButton);
    // then extend the modal header text
    let headerText = "Edit relation" + ": <u><b>" + annotationType_displayName + "</b></u>";
    $("#exampleModalLongTitle").html(headerText);


    // load modal content
    $(":radio[value=" + annotation_certainty + "]").prop("checked", true);
    $('#certaintyModalInput').val(annotation_inputText);

    // load annotation to display all tokens as possible keywords
    var keywordSelectionDIV_1 = $('#keywordSelection_1');
    var keywordSelectionDIV_2 = $('#keywordSelection_2');
    keywordSelectionDIV_1.empty();
    keywordSelectionDIV_2.empty();
    

    if ((Math.abs(currentlySelectedAnnotations.annotation_1.end - currentlySelectedAnnotations.annotation_1.start) < 1) && (Math.abs(currentlySelectedAnnotations.annotation_2.end - currentlySelectedAnnotations.annotation_2.start) < 1)) {
      // hide keywords section title since the selected annotation only contain one token
      $("#keywordSelection-title").addClass("hidden");
    }
    else {
      // unhide keywordSelection-title
      $("#keywordSelection-title").removeClass("hidden");
    }
        

    let annotated_tokens_1 = $("#textToAnnotate #" + relation_annotation_to_edit[0].annotation_1.start).nextUntil("#textToAnnotate #" + relation_annotation_to_edit[0].annotation_1.end).addBack().next().addBack().clone();
    let annotated_tokens_2 = $("#textToAnnotate #" + relation_annotation_to_edit[0].annotation_2.start).nextUntil("#textToAnnotate #" + relation_annotation_to_edit[0].annotation_2.end).addBack().next().addBack().clone();

    $.each(annotated_tokens_1, function(nr, annotatedTokenSpan) {
      if (parseFloat(annotatedTokenSpan.id) % 1 == 0) {
        keywordSelectionDIV_1.append($(annotatedTokenSpan));
      }
    });

    $.each(annotated_tokens_2, function(nr, annotatedTokenSpan) {
      if (parseFloat(annotatedTokenSpan.id) % 1 == 0) {
        keywordSelectionDIV_2.append($(annotatedTokenSpan));
      }
    });


    keywordSelectionDIV_1.children().wrap( "<a class='keywordSelectionButton'></a>" );
    keywordSelectionDIV_2.children().wrap( "<a class='keywordSelectionButton'></a>" );

    $(".keywordSelectionButton span").removeClass();


    // loop through selected keywords to highlight the ones which were selected by the worker
    for (var j = annotation_keywords.keywordSelection_1.length -1; j >= 0; j--) {
      let keyword_parent =$("#keywordSelection_1 #" + annotation_keywords.keywordSelection_1[j] + "").parent();
      $(keyword_parent).addClass("keywordSelectionButton-selected");
    }
    for (var j = annotation_keywords.keywordSelection_2.length -1; j >= 0; j--) {
      let keyword_parent =$("#keywordSelection_2 #" + annotation_keywords.keywordSelection_2[j] + "").parent();
      $(keyword_parent).addClass("keywordSelectionButton-selected");
    }


    // if one of the annotations only contains one token then autoselect it
    if (Math.abs(currentlySelectedAnnotations.annotation_1.end - currentlySelectedAnnotations.annotation_1.start) < 1) {
      $("#keywordSelection_1 #" + currentlySelectedAnnotations.annotation_1.start).parent().addClass("keywordSelectionButton-selected");
      // remove hover css classes
      $("#keywordSelection_1 .keywordSelectionButton-selected").hover(function() {
        $(this).css({"cursor":"default", "background-color":"orange"});
        $(this).addClass("autoselected");
      });
    }

    if (Math.abs(currentlySelectedAnnotations.annotation_2.end - currentlySelectedAnnotations.annotation_2.start) < 1) {
      $("#keywordSelection_2 #" + currentlySelectedAnnotations.annotation_2.start).parent().addClass("keywordSelectionButton-selected");
      // remove hover css classes
      $("#keywordSelection_2 .keywordSelectionButton-selected").hover(function() {
        $(this).css({"cursor":"default", "background-color":"orange"});
        $(this).addClass("autoselected");
      });
    }
  

    // open the modal
    $('#certaintyModal').modal({
      keyboard: false
    });


  }



  function deleteAnnotation(IdToDelete) {
    // this function deletes a relation annotation with a specific ID.
    console.log("deleting:");
    console.log("IdToDelete: " + IdToDelete);
    // remove the corresponding row from the table and also remove the relation from the global object which contains all the relations
    removeRowFromAnnotationRelationsTable(IdToDelete, window.paragraphNumber);

    updateWorkerData();

    logger = logger.concat(Date.now(), "/Delete relation. id=", IdToDelete, "//");

  };


  function getNumberOfFinishPage() {
    return Object.keys(({{text_to_annotate|tojson}})).length
  }

  function getPageState(pageNumber) {
    let numberOfFinishPage = getNumberOfFinishPage();
    if (pageNumber == -1) {
      return "instructionsPage"
    }
    else if (pageNumber == numberOfFinishPage) {
      return "finishPage"
    }
    else {
      return "annotationPage"
    }
    
  };
  

  function updateTextSize() {
    // update the size of the new table row content and the editIcon to match the current font size in case it was changed by the worker
    let currentSize = parseInt($("#textToAnnotate").css('font-size').replace('px', ''));
    let currentSizeTable = parseInt($(".table td").css('font-size').replace('px', ''));
    let currentSizeEditAnnotationIcon = (currentSize+8) + "px";

    $(".table td, .table th").css("fontSize", currentSizeTable);
    $(".editAnnotationIcon").css("fontSize", currentSizeEditAnnotationIcon);

  }

  function disableRelationButtons() {
    // disable annotation buttons
    $('#relationButtons > button').not( "#relationButtons .relationInfoButton" ).prop("disabled",true);
  };

  function enableRelationButtons() {
    // disable annotation buttons
    $('#relationButtons > button').not( "#relationButtons .relationInfoButton" ).prop("disabled",false);
  };


  </script>

  <script>

    $("button#startAnnotation").click(function() {
      jumpToPage(getNewParagraphNumber(-1));
      updateWorkerData();
    });

    
    $("button#nextPageButton").click(function() {
      jumpToPage(getNewParagraphNumber(1));
      updateWorkerData();
    });
    
    $("button#previousPageButton").click(function() {
      jumpToPage(getNewParagraphNumber(0));
      updateWorkerData();
    });

    
    $("button#previousPageButton-feedback").click(function() {
      jumpToPage(getNewParagraphNumber(0));
      updateWorkerData();
      });

    $("button#previousPageButtonFILTERStep1").click(function() {
      jumpToPage(getNewParagraphNumber(0));
      updateWorkerData();
    });

    $("button#checkFilterAnswerStep1").click(function() {
      // set filter (Step 1) to completed
      window.filterData_step1.nr_of_tries += 1;
      // check if filter (Step 1) is passed

      var number_of_questions = 0;
      var correct_answers = [];
      var wrong_answers = [];
      var no_answers = [];
      
      let filter_questions_step1 = ({{filter_questions_step1|tojson}});
      
      $.each(filter_questions_step1, function(question) {

        number_of_questions += 1;
        let solution = filter_questions_step1[question]["solution"];
        let worker_selection = filterData_step1["selectedOptions"].filter(function(e) { return e.question === question; });

        if (worker_selection.length > 0) {
          // the worker answered this question
          
          if (worker_selection[0]["answer"] == solution) {
            // this answer is correct
            correct_answers.push(question);
          }
          else {
            // this answer is wrong
            wrong_answers.push(question);
          }
        }
        else {
          // the worker did not answer this question
          no_answers.push(question);
        }
      });

      window.filterData_step1.correct_answers = correct_answers;
      window.filterData_step1.wrong_answers = wrong_answers;
      window.filterData_step1.no_answers = no_answers;

      if (correct_answers.length == number_of_questions) {
        // filter step 1 has been passed
        window.filterData_step1.filterPassed = true;
      }

      // thank worker for finishing the first part and tell him to continue with real annotation now
      var alert_message = `
      <div id="alert-success-filterpassed" class="alert alert-success alert-dismissible fade show" role="alert" style="display: none;">
        Thank you very much for finishing the <b>Pop Quiz</b>!
        <br>
        Continue now to get yourself a <b>reward</b> of up to a maximum of <b>$5,20</b>. After successful completion of the task, $2,20 will be paid automatically and the rest will be paid as a bonus payment.
        <hr>
        <h6>Please continue now with the annotation of the paragraphs.</h6>
        Keep in mind that the more relations you annotate correctly, the higher your bonus payment will be!
        <br>
        Whenever you need to, you can go back to the instructions or click the <svg width="1em" height="1em"
          viewBox="0 0 16 16" class="bi bi-info-circle" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
          <path
            d="M8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588z" />
          <circle cx="8" cy="4.5" r="1" /></svg> buttons to look at some examples.

        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      `

      updateWorkerData();

      // prepend alert to filter-alerts DIV to make sure that the alert is showed at the top of the page
      $('#filter-alerts').prepend(alert_message);
      $('#alert-success-filterpassed').toggle("slide:right");

      // jump to first paragraph of annotation page. The user will automatically land on the annotation page, no matter whether the filter (Step 1) is passed or not.
      jumpToPage(0);

    });

    // WHEN CLOSE CLICK HIDE THE ALERT MESSAGE.
    $(".alert").on("click", function() {
      // if user clicks on x in top right corner of an alert, close this alert
      $(this).css("display", "none");
    })

    function closeAllAlerts() {
      // close all the open filter (Step 1) page alerts
      $('#filter-alerts').empty();
    }

    function getNewParagraphNumber(direction) {
      if (direction == 0) {
        window.paragraphNumber -= 1;
      }
      else if (direction == 1) {
        window.paragraphNumber += 1;
      }
      else if (direction = -1) {
        window.paragraphNumber = 0;
      }
      
      return window.paragraphNumber;
    };

    function updateWorkerData() {
      updateMTurkForm();
      setAllLocalStorageElements();
    }

    function updateMTurkForm() {
      // set the values of the form inputs so that the data is saved in mturk when user submits the assignment
      $("#submit_annotations").val(JSON.stringify(window.relation_annotations));
      $("#submit_filter_data_step1").val(JSON.stringify(window.filterData_step1));
      $("#submit_worker_assignment_data").val(JSON.stringify({{worker_assignment_data|tojson}}));
      $("#submit_logger").val(window.logger);
    }

    function setAllLocalStorageElements() {

      setLocalStorageElement("lastVisitedPage", (window.paragraphNumber).toString());
      setLocalStorageElement("informedConsentCheckBox", ($("#informedConsentCheckBox").is(':checked')).toString());
      setLocalStorageElement("filterData_step1", JSON.stringify(window.filterData_step1));
      setLocalStorageElement("relation_annotations", JSON.stringify(window.relation_annotations));
      setLocalStorageElement("feedback", $("textarea[name='feedback']").val());
      setLocalStorageElement("logger", window.logger);
      setLocalStorageElement("timestamp", Date.now());

    }

    function loadAllLocalStorageElements() {

      if (getLocalStorageElement("lastVisitedPage") === null) {
        window.paragraphNumber = -1;
      }
      else {
        window.paragraphNumber = parseInt(getLocalStorageElement("lastVisitedPage"));
      }

      if (getLocalStorageElement("informedConsentCheckBox") === null) {
        window.informedConsentCheckBox = false;
      }
      else {
        window.informedConsentCheckBox = (getLocalStorageElement("informedConsentCheckBox") == 'true');
      }

      if (getLocalStorageElement("filterData_step1") === null) {
        window.filterData_step1 = {'filterPassed': false, 'nr_of_tries': 0, 'selectedOptions': [], "correct_answers": [], "wrong_answers": [], "no_answers": []};
      }
      else {
        window.filterData_step1 = JSON.parse(getLocalStorageElement("filterData_step1"));
      }

      if (getLocalStorageElement("relation_annotations") === null) {
        let number_of_paragraphs_to_annotate = Object.keys({{text_to_annotate|tojson}}).length;
        window.relation_annotations = {};
        for (var i = 0; i < number_of_paragraphs_to_annotate; i++) {
          window.relation_annotations[i] = {};
        }
      }
      else {
        window.relation_annotations = JSON.parse(getLocalStorageElement("relation_annotations"));
      }

      if (getLocalStorageElement("feedback") === null) {
        window.feedback = "";
      }
      else {
        window.feedback = getLocalStorageElement("feedback");
      }

      if (getLocalStorageElement("logger") === null) {
        window.logger = "";
      }
      else {
        window.logger = getLocalStorageElement("logger");
      }

    }


    function setLocalStorageElement(name, value) {
      // only set the local storage item if worker is not in preview mode and if browser supports local storage
      let browserSupportsLocalStorage = (typeof(Storage) !== "undefined");
      let workerNotInPreviewMode = ({{preview_mode}} != true);
      if (browserSupportsLocalStorage && workerNotInPreviewMode) {
        let assignment_id = {{worker_assignment_data|tojson}}.assignment_id;
        let local_storage_element_name = assignment_id + name;

        window.localStorage.setItem(local_storage_element_name, value.toString());
      }
    }


    function getLocalStorageElement(name) {
      let assignment_id = {{worker_assignment_data|tojson}}.assignment_id;
      let local_storage_element_name = assignment_id + name;
      return window.localStorage.getItem(local_storage_element_name);
    }

    function jumpToPage(pageNumber) {
      // scroll to the top of the page
      window.scrollTo(0, 0);

      let numberOfParagraphs = Object.keys(({{text_to_annotate|tojson}})).length;
      let pageState = getPageState(pageNumber);

      if (pageState == "instructionsPage") {
        // jump to instructions page
        // show instructions page and hide other divs
        $("div#relationButtons").addClass("hidden");
        $("div#userControls").addClass("hidden");
        $("div#annotationArea-wrapper").addClass("hidden");
        $("div#navigationButtons").addClass("hidden");
        $("div#progress").addClass("hidden");
        $("div#filter-instructions").addClass("hidden");
        $("div#filterButtonsStep1").addClass("hidden");
        $("div#filter_step1_content").addClass("hidden");
        // scroll to the top
        window.scrollTo(0, 0);
        $("div#instructions").removeClass("hidden");

        logger = logger.concat(Date.now(), "/Instructions page", "//");

      }
      else if (pageState == "finishPage") {
        updateProgressBar(numberOfParagraphs-1, numberOfParagraphs);
        // jump to finish page
        // show finish page and hide other divs
        $("div#progress").addClass("hidden"); 
        $("div#relationButtons").addClass("hidden");
        $("div#userControls").addClass("hidden");
        $("div#annotationArea-wrapper").addClass("hidden");
        $("#navigationButtons").addClass("hidden");
        $("div#filterButtonsStep1").addClass("hidden");
        $("div#filter-instructions").addClass("hidden");
        $("div#filter_step1_content").addClass("hidden");

        // scroll to the top
        window.scrollTo(0, 0);
        $("div#feedback").removeClass("hidden");

        logger = logger.concat(Date.now(), "/Finish page", "//");

        // print data on heroku for safety reasons
        printDataOnServer("on FINISH page - RELATION");

      }
      else {
        // check if the filter (Step 1) has been finished
        // the filter (Step 1) does not have to be passed to continue, it just has to be finished by clicking continue
        //if (window.filterData_step1.filterPassed === true) {
        if (window.filterData_step1.nr_of_tries > 0) {
          // ANNOTATION PAGE
          // filter (Step 1) has been passed
          $("div#filter-instructions").addClass("hidden");
          
          resetCurrentlySelectedAnnotations();
          // display annotation page with correct paragraph
          displayTextToAnnotate(pageNumber, window.annotations);
          reloadAnnotationRelationsTable(pageNumber);
          updateProgressBar(pageNumber, numberOfParagraphs);
          $("div#instructions").addClass("hidden");
          $("div#feedback").addClass("hidden");
          $("div#filterButtonsStep1").addClass("hidden");
          $("div#filter_step1_content").addClass("hidden");

          $("div#progress").removeClass("hidden");
          $("div#relationButtons").removeClass("hidden");
          $("div#userControls").removeClass("hidden");
          $("div#annotationArea-wrapper").removeClass("hidden");
          $("div#navigationButtons").removeClass("hidden");
          $("#previousPageButton").html('&laquo; Instructions');

          logger = logger.concat(Date.now(), "/Annotation page. p=", pageNumber, "//");

          if (pageNumber == (numberOfParagraphs-1)) {
            // change value of next button
            $("#nextPageButton").html('Finish &raquo;');
          }
          else {
            $("#nextPageButton").html('Next &raquo;');
          }
          if (pageNumber == 0) {
            // change value of previous button
            $("#previousPageButton").html('&laquo; Instructions');
          }
          else {
            $("#previousPageButton").html('&laquo; Previous');
          }
        }

        else {
          // FILTER (Step 1) PAGE
          // filter (Step 1) has not been completed yet, go to filter (Step 1) page
          $("div#instructions").addClass("hidden");
          $("div#feedback").addClass("hidden");
          $("div#progress").addClass("hidden");
          $("div#relationButtons").addClass("hidden");
          $("div#userControls").addClass("hidden");
          $("div#annotationArea-wrapper").addClass("hidden");
          $("div#navigationButtons").addClass("hidden");
          
          displayQuestionsFILTERSTEP1();
          $("div#filter_step1_content").removeClass("hidden");
          $("div#filterButtonsStep1").removeClass("hidden");
          $("div#filter-instructions").removeClass("hidden");
          $("#previousPageButton").html('&laquo; Instructions');
          
          logger = logger.concat(Date.now(), "/Filter (Step 1) page//");

          if (pageNumber == (numberOfParagraphs-1)) {
            // change value of next button
            $("#nextPageButton").html('Finish &raquo;');
          }
          else {
            $("#nextPageButton").html('Next &raquo;');
          }
          if (pageNumber == 0) {
            // change value of previous button
            $("#previousPageButton").html('&laquo; Instructions');
          }
          else {
            $("#previousPageButton").html('&laquo; Previous');
          }

        }

      }

      // scroll to the top of the page
      window.scrollTo(0, 0);
    };

    function updateProgressBar(newParagraphNumber, numberOfParagraphs) {
      let newWidth = (((newParagraphNumber+1)/numberOfParagraphs) * 100) + '%';
      let newText = '<b>' + (newParagraphNumber+1) + '/' + numberOfParagraphs + '</b>';
      $("div#progress").removeClass("hidden");
      $("div.progress-bar").css( "width", newWidth);
      $("div.progress-bar").html(newText);
    }

  </script>
</html>